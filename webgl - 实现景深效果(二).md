## webgl - 实现景深效果（二）

上回我们说到，仅仅使用简单的混合会导致渲染出现两个问题：
- 后景混入了对焦区域的颜色
- 前景边缘过于清晰 


那么如何解决这两个问题呢？答案是对前景和后景分开做处理。我们可以先处理后景，再处理前景。

后景混入前景的问题好办，在计算模糊时，我们对范围内每一个像素做一个判断，如果是前景或者对焦区域的点，就将其排除掉。

而前景边缘过于清晰的问题就有点小技巧了：首先，我们计算每一个像素的coc。如果是对焦范围内的点或后景，其coc置为零。可以得到一张coc图像，对该图像做模糊，用模糊后的coc图像做混合，这样就可以让前景的边界不那么清晰。但光是这样还是会有一点问题，因为模糊之后，前景边缘本来是1的部分会变得小于1，这样看起来会比较奇怪：




### 具体实现思路
- 第一步，根据coc的正负，可以判断是前景还是后景，还是对焦部分。
    - 如果是后景，计算模糊后的rgb，并根据coc进行混合。注意，在计算模糊后的颜色时，要排除掉其中是前景的部分。然后将a通道设为0。
    - 如果是前景或者对焦部分，rgb不作处理，将a通道设为coc的值。

- 第二步，对上一步得到的图像的a通道进行模糊。模糊后




这个思路是我在GPU Gems里面看到的。传送门：
https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch28.html

